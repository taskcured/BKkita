<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BKita - Bimbingan Konseling Online</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Modern Styling adjustments */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Soft, modern background */
        }
        .container-bkita {
            max-width: 900px;
            /* Enhanced modern card style */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Deeper shadow */
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border-radius: 0.75rem;
        }
        /* Custom styles for appointment slots */
        .slot-available {
            @apply bg-teal-500 hover:bg-teal-600 text-white; /* Teal/Cyan for primary action */
        }
        .slot-pending {
            @apply bg-amber-400 text-gray-800 cursor-not-allowed;
        }
        .slot-approved {
            @apply bg-indigo-500 text-white;
        }
        .slot-approved[disabled] {
            @apply cursor-not-allowed opacity-75;
        }
        .modal {
            @apply fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-40;
        }
        /* Style for the new modern logo */
        .logo-bkita-container {
             /* Ensure the logo is centered and sized correctly */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="container-bkita w-full bg-white p-8 md:p-12">
        <!-- Main Login View -->
        <div id="login-view" class="view">
            <!-- New Modern Logo BKita (Abstract Support & Growth) -->
            <div class="logo-bkita-container w-28 h-28 mx-auto mb-8">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="logoTitle">
                    <title id="logoTitle">Logo BKita</title>
                    <defs>
                        <!-- Vibrant Gradient: Teal to Pink (for friendly, dynamic feel) -->
                        <linearGradient id="gradBKita" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="#06b6d4"/>
                            <stop offset="100%" stop-color="#ff7a9a"/>
                        </linearGradient>
                    </defs>
                    <!-- Outer shape (soft rounded square with gradient) -->
                    <rect x="0" y="0" width="100" height="100" rx="25" fill="url(#gradBKita)"/>
                    
                    <!-- Abstract Symbol: Two interlocking/overlapping shapes representing 'Bimbingan' (Guidance) and 'Kita' (Community/Support/Growth) -->
                    <g fill="#ffffff" transform="translate(10, 10) scale(0.8)">
                        <!-- Support Arch (Community/Kita) -->
                        <path d="M 30 20 C 10 35 10 65 30 80 L 38 80 C 25 68 25 32 38 20 Z" />
                        <!-- Inner Growth Path (Guidance/Bimbingan) -->
                        <path d="M 50 30 L 75 30 L 75 40 L 58 40 L 58 60 L 75 60 L 75 70 L 50 70 L 50 60 L 60 50 L 50 40 L 50 30 Z" />
                    </g>
                </svg>
            </div>
            <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-2">BKita</h1>
            <p class="text-center text-gray-500 mb-10">Platform Bimbingan Konseling Digital Sekolah Anda</p>
            <div class="space-y-4 max-w-sm mx-auto">
                <button id="show-student-login-btn" class="w-full py-4 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200/50 transition-all duration-300 transform hover:scale-[1.01]">
                    Masuk Sebagai Siswa
                </button>
                <div class="flex items-center">
                    <hr class="flex-grow border-t border-gray-200">
                    <span class="mx-4 text-gray-400 text-sm font-medium">ATAU</span>
                    <hr class="flex-grow border-t border-gray-200">
                </div>
                <button id="show-admin-login-btn" class="w-full py-4 px-6 bg-gray-700 hover:bg-gray-800 text-white font-bold rounded-xl shadow-lg shadow-gray-300/50 transition-all duration-300 transform hover:scale-[1.01]">
                    Masuk Sebagai Admin
                </button>
            </div>
        </div>

        <!-- Student Login View -->
        <div id="student-login-view" class="view hidden">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Masuk Siswa</h1>
            <p class="text-center text-gray-600 mb-8">Masukkan nama dan password untuk akses ke layanan BK.</p>
            <div class="space-y-4 max-w-sm mx-auto">
                <input type="text" id="student-name-input" placeholder="Nama Anda (cth: Budi)" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                <input type="password" id="student-password-input" placeholder="Password" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                <button id="student-login-btn" class="w-full py-4 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-md transition-colors duration-300">
                    Masuk
                </button>
                <button id="student-back-btn" class="w-full py-3 px-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-xl transition-colors duration-300">
                    Kembali
                </button>
            </div>
        </div>

        <!-- Admin Login View -->
        <div id="admin-login-view" class="view hidden">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Masuk Admin BK</h1>
            <p class="text-center text-gray-600 mb-8">Masukkan nama dan password Anda.</p>
            <div class="space-y-4 max-w-sm mx-auto">
                <input type="text" id="admin-name-input" placeholder="Nama Admin (Gofar/Rohman)" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                <input type="password" id="admin-password" placeholder="Password" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                <button id="admin-login-btn" class="w-full py-4 px-6 bg-gray-700 hover:bg-gray-800 text-white font-bold rounded-xl shadow-md transition-colors duration-300">
                    Masuk
                </button>
                <button id="admin-back-btn-from-login" class="w-full py-3 px-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-xl transition-colors duration-300">
                    Kembali
                </button>
            </div>
        </div>

        <!-- User Dashboard View -->
        <div id="user-dashboard-view" class="view hidden">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center pb-4 border-b border-gray-200 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2 md:mb-0">Selamat Datang, <span id="student-name-header" class="text-blue-600">Siswa</span>!</h1>
                <button id="logout-btn" class="py-2 px-4 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors duration-300 shadow-md">
                    Keluar
                </button>
            </header>
            
            <!-- Tab Navigation (Pills style for modern look) -->
            <div class="flex bg-gray-100 p-1 rounded-xl mb-8 overflow-x-auto">
                <button id="tab-appointment" class="flex-1 py-2 px-4 whitespace-nowrap text-center text-sm font-semibold transition-all duration-300 rounded-lg bg-white shadow-sm text-blue-600">
                    üìÖ Janji Temu
                </button>
                <button id="tab-chat" class="flex-1 py-2 px-4 whitespace-nowrap text-center text-sm font-medium focus:outline-none transition-all duration-300 text-gray-600 hover:bg-white hover:shadow-sm rounded-lg">
                    üí¨ Chat Privat
                </button>
                <button id="tab-articles" class="flex-1 py-2 px-4 whitespace-nowrap text-center text-sm font-medium focus:outline-none transition-all duration-300 text-gray-600 hover:bg-white hover:shadow-sm rounded-lg">
                    üß† Materi Motivasi
                </button>
                 <button id="tab-change-password" class="flex-1 py-2 px-4 whitespace-nowrap text-center text-sm font-medium focus:outline-none transition-all duration-300 text-gray-600 hover:bg-white hover:shadow-sm rounded-lg">
                    üîë Ganti Password
                </button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Tab Janji Temu -->
                <div id="content-appointment" class="tab-content">
                    <h2 class="text-2xl font-extrabold mb-6 text-gray-800">Pilih Waktu Konseling</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="p-6 bg-gray-50 rounded-xl border border-gray-100 shadow-lg col-span-1 lg:col-span-2">
                            <h3 class="font-bold text-xl mb-4 text-gray-700">Jadwal Guru BK Hari Ini</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <!-- Gofar Slots -->
                                <div class="p-4 bg-white rounded-lg shadow-inner">
                                    <h4 class="font-bold text-lg mb-3 border-b pb-2 text-teal-600">Bapak Gofar</h4>
                                    <div id="gofar-slots" class="grid grid-cols-2 gap-2 text-sm">
                                        <!-- Slots for Gofar will be rendered here -->
                                    </div>
                                </div>
                                <!-- Rohman Slots -->
                                <div class="p-4 bg-white rounded-lg shadow-inner">
                                    <h4 class="font-bold text-lg mb-3 border-b pb-2 text-teal-600">Bapak Rohman</h4>
                                    <div id="rohman-slots" class="grid grid-cols-2 gap-2 text-sm">
                                        <!-- Slots for Rohman will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status Appointment -->
                        <div class="p-6 bg-white rounded-xl shadow-lg border-t-4 border-indigo-500">
                            <h3 class="font-extrabold text-xl mb-4 text-indigo-700">Status Janji Temu Anda</h3>
                            <div id="my-appointments" class="space-y-3">
                                <!-- My appointments will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Chat Privat -->
                <div id="content-chat" class="tab-content hidden">
                    <div class="bg-indigo-50 rounded-xl p-8 shadow-xl">
                        <h2 class="text-2xl font-extrabold mb-4 text-center text-indigo-800">Chat Privat via WhatsApp</h2>
                        <p class="text-center text-gray-600 mb-8">Anda dapat langsung terhubung dengan guru BK untuk konsultasi cepat atau mendesak.</p>
                        <div class="flex justify-center space-x-6">
                            <a id="chat-gofar-btn" href="#" target="_blank" class="flex items-center py-3 px-6 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition-colors duration-300 shadow-lg shadow-green-200/50">
                                üü¢ Chat Gofar
                            </a>
                            <a id="chat-rohman-btn" href="#" target="_blank" class="flex items-center py-3 px-6 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition-colors duration-300 shadow-lg shadow-green-200/50">
                                üü¢ Chat Rohman
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Tab Materi Motivasi -->
                <div id="content-articles" class="tab-content hidden">
                    <h2 class="text-2xl font-extrabold mb-6 text-gray-800">Materi Pengembangan Diri & Inspirasi</h2>
                    <div id="article-list" class="space-y-6">
                        <!-- Articles will be rendered here -->
                    </div>
                </div>
                
                <!-- Tab Ganti Password -->
                <div id="content-change-password" class="tab-content hidden">
                    <h2 class="text-2xl font-extrabold mb-6 text-gray-800">Ganti Password Anda</h2>
                    <div class="bg-gray-100 rounded-xl p-6 shadow-md space-y-4 max-w-md mx-auto">
                        <input type="password" id="old-password-input" placeholder="Password Lama" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                        <input type="password" id="new-password-input" placeholder="Password Baru (min. 4 karakter)" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                        <input type="password" id="confirm-password-input" placeholder="Konfirmasi Password Baru" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                        <button id="update-password-btn" class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-md transition-colors duration-300">
                            Simpan Password Baru
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Admin Dashboard View -->
        <div id="admin-dashboard-view" class="view hidden">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center pb-4 border-b border-gray-200 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2 md:mb-0">Dasbor Admin <span id="admin-name-header" class="text-blue-600"></span></h1>
                <button id="admin-logout-btn" class="py-2 px-4 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors duration-300 shadow-md">
                    Keluar
                </button>
            </header>
            
            <!-- Tab Navigation for Admin (Pills style) -->
            <div class="flex bg-gray-100 p-1 rounded-xl mb-8 overflow-x-auto">
                <button id="admin-tab-appointments" class="flex-1 py-2 px-4 whitespace-nowrap text-center text-sm font-semibold transition-all duration-300 rounded-lg bg-white shadow-sm text-blue-600">
                    üõéÔ∏è Permintaan Janji Temu
                </button>
                <button id="admin-tab-add-article" class="flex-1 py-2 px-4 whitespace-nowrap text-center text-sm font-medium focus:outline-none transition-all duration-300 text-gray-600 hover:bg-white hover:shadow-sm rounded-lg">
                    ‚úçÔ∏è Tambah Materi
                </button>
                <button id="admin-tab-manage-accounts" class="flex-1 py-2 px-4 whitespace-nowrap text-center text-sm font-medium focus:outline-none transition-all duration-300 text-gray-600 hover:bg-white hover:shadow-sm rounded-lg">
                    üë• Kelola Akun
                </button>
                <button id="admin-tab-change-password" class="flex-1 py-2 px-4 whitespace-nowrap text-center text-sm font-medium focus:outline-none transition-all duration-300 text-gray-600 hover:bg-white hover:shadow-sm rounded-lg">
                    üîë Ganti Password
                </button>
            </div>

            <!-- Tab Content for Admin -->
            <div id="admin-tab-content">
                <!-- Admin Tab Janji Temu -->
                <div id="admin-content-appointments" class="tab-content">
                    <h2 class="text-2xl font-extrabold mb-6 text-gray-800">Kelola Permintaan Janji Temu Berdasarkan Kategori</h2>
                    <div id="admin-appointment-list" class="space-y-4">
                        <!-- Appointment requests will be rendered here grouped by category -->
                    </div>
                </div>

                <!-- Admin Tab Tambah Materi -->
                <div id="admin-content-add-article" class="tab-content hidden">
                    <h2 class="text-2xl font-extrabold mb-6 text-gray-800">Tulis Materi Motivasi Baru</h2>
                    <div class="bg-gray-100 rounded-xl p-6 shadow-md space-y-4">
                        <input type="text" id="article-title-input" placeholder="Judul Materi" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                        <textarea id="article-content-input" placeholder="Isi materi..." rows="8" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow"></textarea>
                        <button id="save-article-btn" class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-md transition-colors duration-300">
                            Simpan Materi
                        </button>
                    </div>
                </div>
                
                <!-- Admin Tab Kelola Akun - UPDATED WITH NEW STUDENT CREATION -->
                <div id="admin-content-manage-accounts" class="tab-content hidden">
                    <h2 class="text-2xl font-extrabold mb-6 text-gray-800">Kelola Akun Siswa</h2>

                    <!-- NEW: Tambah Akun Siswa Baru -->
                    <div class="bg-blue-50 rounded-xl p-6 shadow-md mb-8">
                        <h3 class="text-xl font-bold text-blue-700 mb-4">‚ûï Tambah Akun Siswa Baru</h3>
                        <p class="text-sm text-gray-600 mb-4">Password akan diatur secara otomatis ke **'12345'**.</p>
                        <div class="flex space-x-3">
                            <input type="text" id="new-student-name-input" placeholder="Nama Siswa Baru (cth: Ani)" class="flex-grow p-3 rounded-xl border border-blue-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                            <button id="add-new-student-btn" class="py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-md transition-colors duration-300">
                                Buat Akun
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-extrabold mb-4 text-gray-800">Daftar Akun Siswa</h3>
                    <p class="text-gray-600 mb-4">Pilih nama siswa untuk mereset password atau menghapus akun.</p>
                    <div id="user-list-for-reset" class="space-y-3 p-4 bg-white rounded-xl shadow-md">
                        <!-- User list for password reset -->
                    </div>
                </div>
                
                <!-- Admin Tab Ganti Password -->
                <div id="admin-content-change-password" class="tab-content hidden">
                    <h2 class="text-2xl font-extrabold mb-6 text-gray-800">Ganti Password Anda</h2>
                    <div class="bg-gray-100 rounded-xl p-6 shadow-md space-y-4 max-w-md mx-auto">
                        <input type="password" id="admin-old-password-input" placeholder="Password Lama" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                        <input type="password" id="admin-new-password-input" placeholder="Password Baru (min. 4 karakter)" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                        <input type="password" id="admin-confirm-password-input" placeholder="Konfirmasi Password Baru" class="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-100 transition-shadow">
                        <button id="admin-update-password-btn" class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-md transition-colors duration-300">
                            Simpan Password Baru
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- 1. Confirmation Modal (for Booking - with Category and Optional Reason) -->
        <div id="booking-confirmation-modal" class="modal hidden">
            <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-lg w-full transform transition-all">
                <h3 class="text-2xl font-bold mb-4 text-blue-600">Konfirmasi Janji Temu</h3>
                <p id="booking-modal-text" class="text-gray-700 mb-6">Pilih kategori masalah utama Anda. Detail singkat adalah opsional.</p>
                
                <label for="appointment-category-select" class="block text-sm font-medium text-gray-700 mb-1">Kategori Masalah <span class="text-red-500">* Wajib</span></label>
                <select id="appointment-category-select" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                    <option value="">-- Pilih Kategori --</option>
                    <option value="Akademik">Akademik (Nilai, Belajar, Jurusan)</option>
                    <option value="Sosial">Sosial (Pergaulan, Konflik, Perundungan)</option>
                    <option value="Karir/Masa Depan">Karir/Masa Depan (Pilihan Universitas/Kerja)</option>
                    <option value="Pribadi">Pribadi (Emosi, Stres, Keluarga)</option>
                    <option value="Lainnya">Lainnya</option>
                </select>

                <label for="appointment-reason-input" class="block text-sm font-medium text-gray-700 mb-1">Detail Singkat (Opsional)</label>
                <textarea id="appointment-reason-input" placeholder="Jelaskan secara singkat atau detail (Opsional)..." rows="3" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6"></textarea>

                <div class="flex justify-end space-x-4">
                    <button id="booking-modal-cancel-btn" class="py-2 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl transition-colors">Batal</button>
                    <button id="booking-modal-confirm-btn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-colors">Konfirmasi</button>
                </div>
            </div>
        </div>
        
        <!-- 2. Generic Confirmation Modal (For Cancel/Reject Actions - No input) -->
        <div id="generic-confirmation-modal" class="modal hidden">
            <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-lg w-full transform transition-all">
                <h3 id="generic-modal-title" class="text-2xl font-bold mb-4 text-red-600">Konfirmasi Aksi</h3>
                <p id="generic-modal-text" class="text-gray-700 mb-6">Apakah Anda yakin ingin melakukan aksi ini?</p>
                <div class="flex justify-end space-x-4">
                    <button id="generic-modal-cancel-btn" class="py-2 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl transition-colors">Batal</button>
                    <button id="generic-modal-confirm-btn" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-colors">Ya, Konfirmasi</button>
                </div>
            </div>
        </div>

        <!-- Custom Alert Modal (Replaces browser alert()) -->
        <div id="alert-modal" class="modal hidden">
            <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-sm w-full transform transition-all">
                <h3 id="alert-title" class="text-xl font-bold mb-4 text-gray-800">Informasi</h3>
                <p id="alert-text" class="text-gray-700 mb-6">Pesan.</p>
                <div class="flex justify-end">
                    <button id="alert-ok-btn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-colors">OK</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global state variables
        let currentUser = null;
        let currentRole = null;
        const ADMIN_BYPASS_TOKEN = 'bypassadmin';
        // UPDATED: Default student password is now '12345'
        const DEFAULT_STUDENT_PASSWORD = '12345'; 
        const DEFAULT_ADMIN_PASSWORD = '123456';

        let pendingAppointment = null;
        let genericActionCallback = null; // Store the callback function for generic confirmation

        // localStorage keys
        const USERS_KEY = 'bkita_users';
        const APPOINTMENTS_KEY = 'bkita_appointments';
        const ARTICLES_KEY = 'bkita_articles';
        
        // Initial Mock Users (used if localStorage is empty)
        const MOCK_USERS = [
            // Ensure mock users use the new default password for consistency
            { name: 'Budi', role: 'user', password: DEFAULT_STUDENT_PASSWORD },
            { name: 'Santi', role: 'user', password: DEFAULT_STUDENT_PASSWORD },
            { name: 'Gofar', role: 'admin', password: '123456' },
            { name: 'Rohman', role: 'admin', password: '123456' }
        ];

        // Counselor WhatsApp numbers (Example numbers)
        const gofarNumber = '6283147559807'; 
        const rohmanNumber = '6281388464385';

        // Load data from localStorage
        let users = JSON.parse(localStorage.getItem(USERS_KEY));
        if (!users || users.length === 0) {
            users = MOCK_USERS;
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
        }

        let appointments = JSON.parse(localStorage.getItem(APPOINTMENTS_KEY)) || [];
        let articles = JSON.parse(localStorage.getItem(ARTICLES_KEY)) || [
            { title: "Kiat Sukses Belajar Online", author: "Gofar", content: "Tiga kunci utama sukses belajar online adalah: 1. Disiplin waktu, 2. Cari tempat yang nyaman, 3. Aktif bertanya pada guru." },
            { title: "Mengelola Stres Saat Ujian", author: "Rohman", content: "Lakukan teknik pernapasan 4-7-8 untuk menenangkan pikiran sebelum ujian. Ingat, usaha terbaik lebih penting daripada hasil akhir." }
        ];
        saveArticles(); // Initialize with mock data if empty

        // --- DOM elements ---
        const loginView = document.getElementById('login-view');
        const studentLoginView = document.getElementById('student-login-view');
        const adminLoginView = document.getElementById('admin-login-view');
        const userDashboardView = document.getElementById('user-dashboard-view');
        const adminDashboardView = document.getElementById('admin-dashboard-view');

        const studentNameHeader = document.getElementById('student-name-header');
        const adminNameHeader = document.getElementById('admin-name-header');

        const gofarSlots = document.getElementById('gofar-slots');
        const rohmanSlots = document.getElementById('rohman-slots');
        const myAppointments = document.getElementById('my-appointments');

        const adminAppointmentList = document.getElementById('admin-appointment-list');
        const articleList = document.getElementById('article-list');
        const userListForReset = document.getElementById('user-list-for-reset');
        
        // New Student Creation Input
        const newStudentNameInput = document.getElementById('new-student-name-input');
        const addNewStudentBtn = document.getElementById('add-new-student-btn');


        // Booking Modal elements
        const bookingConfirmationModal = document.getElementById('booking-confirmation-modal');
        const bookingModalText = document.getElementById('booking-modal-text');
        const bookingModalConfirmBtn = document.getElementById('booking-modal-confirm-btn');
        const bookingModalCancelBtn = document.getElementById('booking-modal-cancel-btn');
        const appointmentCategorySelect = document.getElementById('appointment-category-select'); 
        const appointmentReasonInput = document.getElementById('appointment-reason-input');
        
        // Generic Confirmation Modal elements
        const genericConfirmationModal = document.getElementById('generic-confirmation-modal');
        const genericModalTitle = document.getElementById('generic-modal-title');
        const genericModalText = document.getElementById('generic-modal-text');
        const genericModalConfirmBtn = document.getElementById('generic-modal-confirm-btn');
        const genericModalCancelBtn = document.getElementById('generic-modal-cancel-btn');

        // Alert Modal elements
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertText = document.getElementById('alert-text');
        const alertOkBtn = document.getElementById('alert-ok-btn');

        // --- Helper Functions ---
        
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function saveAppointments() {
            localStorage.setItem(APPOINTMENTS_KEY, JSON.stringify(appointments));
        }

        function saveArticles() {
            localStorage.setItem(ARTICLES_KEY, JSON.stringify(articles));
        }
        
        function saveUsers() {
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
        }

        function updateUserPassword(userName, newPassword) {
            const userIndex = users.findIndex(u => u.name.toLowerCase() === userName.toLowerCase());
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                saveUsers();
                return true;
            }
            return false;
        }

        // Custom Alert function to replace browser alert()
        function showAlert(message, type = 'info') {
            alertText.innerHTML = message; // Use innerHTML for bold formatting
            
            // Reset classes and apply new ones based on type
            alertTitle.className = 'text-xl font-bold mb-4';
            switch (type) {
                case 'success':
                    alertTitle.textContent = 'Berhasil';
                    alertTitle.classList.add('text-green-600');
                    break;
                case 'error':
                    alertTitle.textContent = 'Peringatan';
                    alertTitle.classList.add('text-red-600');
                    break;
                case 'info':
                default:
                    alertTitle.textContent = 'Informasi';
                    alertTitle.classList.add('text-blue-600');
                    break;
            }
            
            alertModal.classList.remove('hidden');
        }
        
        /**
         * Generic Confirmation Modal for cancellation/rejection actions.
         * @param {string} title - Title of the modal.
         * @param {string} text - Confirmation question/message.
         * @param {function} callback - Function to execute if confirmed.
         * @param {string} confirmBtnClass - Tailwind classes for the confirm button.
         */
        function showGenericConfirmation(title, text, callback, confirmBtnClass = 'bg-red-600 hover:bg-red-700') {
            genericModalTitle.textContent = title;
            genericModalText.innerHTML = text; // Use innerHTML for bold formatting
            
            // Set button style dynamically (e.g., red for cancel, blue for accept)
            genericModalConfirmBtn.className = `py-2 px-4 text-white font-semibold rounded-xl transition-colors ${confirmBtnClass}`;
            
            // Store the action to be performed
            genericActionCallback = callback;
            genericConfirmationModal.classList.remove('hidden');
        }

        function hideGenericConfirmation() {
            genericConfirmationModal.classList.add('hidden');
            genericActionCallback = null;
        }

        // Handle generic confirmation click
        genericModalConfirmBtn.addEventListener('click', () => {
            if (genericActionCallback) {
                genericActionCallback();
            }
            hideGenericConfirmation();
        });

        genericModalCancelBtn.addEventListener('click', hideGenericConfirmation);


        // Daily reset of appointments
        function resetAppointments() {
            const now = new Date();
            const lastReset = localStorage.getItem('last_reset_date');
            const today = now.toISOString().slice(0, 10);
            
            // Example: Reset after 15:30 WIB
            const resetTime = 15 * 60 + 30; 
            const currentTime = now.getHours() * 60 + now.getMinutes();

            if (currentTime >= resetTime && lastReset !== today) {
                // For simplicity in this demo, we'll clear them daily after 15:30
                appointments = []; 
                saveAppointments();
                localStorage.setItem('last_reset_date', today);
            }
        }
        
        // --- Appointment Generation and Rendering ---
        
        function getAppointmentSlots() {
            const slots = [];
            const startTimeInMinutes = 6 * 60 + 30; // 06:30
            const endTimeInMinutes = 15 * 60 + 30;   // 15:30
            const slotDuration = 45;

            const breaks = [
                { start: 9 * 60 + 30, end: 9 * 60 + 45 },   // 09:30 - 09:45
                { start: 12 * 60 + 0, end: 12 * 60 + 45 },  // 12:00 - 12:45
            ];

            let currentMinutes = startTimeInMinutes;

            while (currentMinutes < endTimeInMinutes) {
                let slotStart = currentMinutes;
                let slotEnd = slotStart + slotDuration;
                
                // If slot would end after working hours, break loop
                if (slotEnd > endTimeInMinutes) {
                    break;
                }
                
                let inBreak = false;
                for (const breakPeriod of breaks) {
                    // Check if the proposed slot overlaps with this break
                    if (slotStart < breakPeriod.end && slotEnd > breakPeriod.start) {
                        // If it overlaps, jump the current time to the end of the break
                        currentMinutes = breakPeriod.end;
                        inBreak = true;
                        break; // Exit the for...of loop for breaks
                    }
                }
                
                // If we found a break, the while loop will continue with the new currentMinutes
                if (inBreak) {
                    continue;
                }

                // If no break, this is a valid slot
                const startH = Math.floor(slotStart / 60);
                const startM = slotStart % 60;
                const endH = Math.floor(slotEnd / 60);
                const endM = slotEnd % 60;

                const startStr = `${String(startH).padStart(2, '0')}:${String(startM).padStart(2, '0')}`;
                const endStr = `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;
                
                slots.push(`${startStr}-${endStr}`);
                
                // Move to the next potential slot time
                currentMinutes += slotDuration;
            }

            return slots;
        }

        function renderAppointmentSlots() {
            const slots = getAppointmentSlots();
            gofarSlots.innerHTML = '';
            rohmanSlots.innerHTML = '';

            const todayAppointments = appointments.filter(app => new Date(app.date).toDateString() === new Date().toDateString());
            
            // Check if current user has any pending appointment today
            const hasPendingAppointment = todayAppointments.some(app => app.studentName === currentUser && app.status === 'pending');

            ['Gofar', 'Rohman'].forEach(counselor => {
                const container = counselor === 'Gofar' ? gofarSlots : rohmanSlots;
                slots.forEach(slot => {
                    const approvedAppointment = todayAppointments.find(
                        app => app.counselorName === counselor && app.timeSlot === slot && app.status === 'approved'
                    );
                    
                    const btn = document.createElement('button');
                    btn.textContent = slot;
                    btn.className = `w-full py-2 px-1 rounded-lg font-semibold text-sm transition-all duration-300 shadow-sm`;
                    
                    if (approvedAppointment) {
                        btn.disabled = true;
                        btn.classList.add('slot-approved');
                        btn.textContent = `${slot} (Terisi)`;
                    } else if (hasPendingAppointment) {
                        btn.disabled = true;
                        btn.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                        btn.title = 'Anda sudah memiliki permintaan janji temu yang menunggu persetujuan.';
                    } else {
                        btn.classList.add('slot-available');
                        // Use the booking modal for initiating a new appointment
                        btn.onclick = () => showBookingConfirmation(counselor, slot);
                    }
                    container.appendChild(btn);
                });
            });
        }
        
        // Booking Modal Functions (Initiating Appointment)
        function showBookingConfirmation(counselorName, timeSlot) {
            pendingAppointment = {
                counselorName,
                timeSlot,
                studentName: currentUser,
            };
            bookingModalText.textContent = `Anda akan membuat janji temu dengan ${counselorName} pada jam ${timeSlot} WIB. Pilih kategori masalah dan jelaskan secara singkat (opsional).`;
            
            // Reset input values when modal is shown
            appointmentCategorySelect.value = '';
            appointmentReasonInput.value = '';

            bookingConfirmationModal.classList.remove('hidden');
        }

        function hideBookingConfirmation() {
            bookingConfirmationModal.classList.add('hidden');
            pendingAppointment = null;
            appointmentCategorySelect.value = '';
            appointmentReasonInput.value = '';
        }

        function confirmAppointment() {
            const category = appointmentCategorySelect.value; 
            const reason = appointmentReasonInput.value.trim();
            
            if (!category) {
                showAlert('Anda wajib memilih **Kategori Masalah**.', 'error');
                return;
            }

            if (pendingAppointment) {
                const now = new Date();
                const newAppointment = {
                    studentName: pendingAppointment.studentName,
                    counselorName: pendingAppointment.counselorName,
                    timeSlot: pendingAppointment.timeSlot,
                    category: category, 
                    reason: reason || 'Tidak ada detail tambahan.', 
                    status: 'pending',
                    date: now.toISOString(),
                };
                appointments.push(newAppointment);
                saveAppointments();
                renderMyAppointments();
                renderAppointmentSlots(); 
                hideBookingConfirmation();
                showAlert('Janji temu berhasil diajukan! Mohon menunggu persetujuan dari guru BK.', 'success');
            }
        }
        
        function renderMyAppointments() {
            myAppointments.innerHTML = '';
            const today = new Date().toDateString();
            // Filter appointments for the current user and today's date
            const myTodayAppointments = appointments.filter(app => 
                app.studentName === currentUser && new Date(app.date).toDateString() === today
            );

            if (myTodayAppointments.length === 0) {
                myAppointments.innerHTML = '<p class="text-gray-500 text-sm italic">Anda belum membuat janji temu hari ini.</p>';
            } else {
                myTodayAppointments.forEach(app => {
                    const isApproved = app.status === 'approved';
                    const isRejected = app.status === 'rejected'; // Check for rejected status

                    // Define status text and class based on status
                    const statusClass = isApproved 
                        ? 'bg-indigo-100 text-indigo-800 border-l-4 border-indigo-500' 
                        : (isRejected 
                            ? 'bg-red-100 text-red-800 border-l-4 border-red-500' // Style for Rejected
                            : 'bg-amber-100 text-amber-800 border-l-4 border-amber-500'); // Style for Pending

                    const statusText = isApproved 
                        ? 'Diterima' 
                        : (isRejected 
                            ? 'Ditolak' 
                            : 'Menunggu Persetujuan');
                    
                    const card = document.createElement('div');
                    card.className = `p-4 rounded-xl shadow-md ${statusClass} relative`;
                    
                    let contentHTML = `
                        <p class="font-bold text-lg mb-1">${app.timeSlot} | ${app.counselorName}</p>
                        <p class="text-sm font-semibold mb-2">Status: <span class="uppercase">${statusText}</span></p>
                        <p class="text-xs text-gray-700">Kategori: <span class="font-medium">${app.category}</span></p>
                        <p class="text-xs text-gray-700 italic">Detail: ${app.reason}</p>
                    `;

                    // Add Cancel button only if the status is pending or approved (for cancellation)
                    if (!isRejected) {
                        contentHTML += `
                            <button class="cancel-appointment-btn mt-3 py-1 px-3 bg-red-500 hover:bg-red-600 text-white text-xs font-semibold rounded-lg transition-colors" data-timeslot="${app.timeSlot}" data-counselor="${app.counselorName}">
                                Batalkan
                            </button>
                        `;
                    }
                    
                    card.innerHTML = contentHTML;
                    myAppointments.appendChild(card);
                });
                
                // Attach event listeners for cancel buttons
                document.querySelectorAll('.cancel-appointment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const timeSlot = e.target.dataset.timeslot;
                        const counselor = e.target.dataset.counselor;
                        
                        showGenericConfirmation(
                            'Batalkan Janji Temu',
                            `Apakah Anda yakin ingin membatalkan janji temu dengan **${counselor}** pada jam **${timeSlot}**?`,
                            () => handleCancelAppointment(timeSlot, counselor),
                            'bg-red-600 hover:bg-red-700'
                        );
                    });
                });
            }
        }
        
        function handleCancelAppointment(timeSlot, counselor) {
            const index = appointments.findIndex(app => 
                app.studentName === currentUser && 
                app.counselorName === counselor && 
                app.timeSlot === timeSlot &&
                new Date(app.date).toDateString() === new Date().toDateString()
            );

            if (index !== -1) {
                appointments.splice(index, 1);
                saveAppointments();
                renderMyAppointments();
                renderAppointmentSlots();
                showAlert('Janji temu berhasil dibatalkan.', 'success');
            }
        }
        
        // --- Article Rendering ---
        function renderArticles() {
            articleList.innerHTML = '';
            articles.slice().reverse().forEach((article, index) => { // show latest first
                const articleElement = document.createElement('div');
                articleElement.className = 'p-6 bg-white rounded-xl shadow-lg border-l-4 border-teal-500';
                articleElement.innerHTML = `
                    <h3 class="text-xl font-bold text-teal-700 mb-2">${article.title}</h3>
                    <p class="text-sm text-gray-500 mb-4">Ditulis oleh: ${article.author}</p>
                    <p class="text-gray-700 whitespace-pre-wrap">${article.content}</p>
                `;
                articleList.appendChild(articleElement);
            });
        }
        
        // --- Admin Functions ---
        
        function renderAdminAppointments() {
            adminAppointmentList.innerHTML = '';
            const today = new Date().toDateString();
            const filteredAppointments = appointments.filter(app => new Date(app.date).toDateString() === today);
            
            const grouped = filteredAppointments.reduce((acc, app) => {
                const key = app.category;
                if (!acc[key]) {
                    acc[key] = [];
                }
                acc[key].push(app);
                return acc;
            }, {});

            if (filteredAppointments.length === 0) {
                 adminAppointmentList.innerHTML = '<p class="text-gray-500 text-lg p-6 bg-white rounded-xl shadow-inner">Belum ada permintaan janji temu hari ini.</p>';
                 return;
            }

            Object.keys(grouped).sort().forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-8 p-6 bg-white rounded-xl shadow-xl';
                categoryDiv.innerHTML = `<h3 class="text-xl font-extrabold text-indigo-700 mb-4 border-b pb-2">Kategori: ${category} (${grouped[category].length})</h3>`;
                
                grouped[category].sort((a, b) => a.timeSlot.localeCompare(b.timeSlot)).forEach((app, index) => {
                    const statusClass = app.status === 'approved' ? 'bg-indigo-50 border-indigo-400' : 
                                        (app.status === 'rejected' ? 'bg-red-50 border-red-400' : 'bg-amber-50 border-amber-400');
                    
                    const appDiv = document.createElement('div');
                    appDiv.className = `p-4 border-l-4 ${statusClass} rounded-lg mb-3 shadow-sm`;
                    
                    let buttonsHTML = '';
                    if (app.status === 'pending') {
                        buttonsHTML = `
                            <div class="flex space-x-2 mt-3">
                                <button class="approve-btn py-1 px-3 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition-colors" data-index="${appointments.indexOf(app)}">
                                    ‚úÖ Setuju
                                </button>
                                <button class="reject-btn py-1 px-3 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition-colors" data-index="${appointments.indexOf(app)}">
                                    ‚ùå Tolak
                                </button>
                            </div>
                        `;
                    } else {
                         buttonsHTML = `<div class="flex items-center space-x-3 mt-2">
                            <p class="text-sm font-semibold ${app.status === 'approved' ? 'text-indigo-600' : 'text-red-600'}">Status: ${app.status.toUpperCase()}</p>
                            ${app.status === 'approved' ? `
                            <button class="finish-appointment-btn py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold rounded-lg transition-colors" data-index="${appointments.indexOf(app)}">
                                ‚úîÔ∏è Selesai
                            </button>` : ''}
                            ${app.status === 'rejected' ? `
                            <button class="delete-rejected-btn py-1 px-3 bg-gray-500 hover:bg-gray-600 text-white text-xs font-semibold rounded-lg transition-colors" data-index="${appointments.indexOf(app)}">
                                üóëÔ∏è Hapus Riwayat
                            </button>` : ''}
                         </div>`;
                    }

                    appDiv.innerHTML = `
                        <p class="font-bold text-lg">${app.timeSlot} | ${app.studentName} (dengan ${app.counselorName})</p>
                        <p class="text-sm text-gray-700 italic">Detail: ${app.reason}</p>
                        ${buttonsHTML}
                    `;
                    categoryDiv.appendChild(appDiv);
                });
                adminAppointmentList.appendChild(categoryDiv);
            });
            
            // Attach event listeners for admin actions
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const app = appointments[index];
                    showGenericConfirmation(
                        'Setujui Janji Temu',
                        `Yakin ingin **menyetujui** janji temu ${app.studentName} pada ${app.timeSlot}?`,
                        () => handleAdminAction(index, 'approved'),
                        'bg-green-600 hover:bg-green-700'
                    );
                });
            });

            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const app = appointments[index];
                    showGenericConfirmation(
                        'Tolak Janji Temu',
                        `Yakin ingin **menolak** janji temu ${app.studentName} pada ${app.timeSlot}?`,
                        () => handleAdminAction(index, 'rejected'),
                        'bg-red-600 hover:bg-red-700'
                    );
                });
            });

            document.querySelectorAll('.finish-appointment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const app = appointments[index];
                    showGenericConfirmation(
                        'Selesaikan Janji Temu',
                        `Menyelesaikan janji temu dengan **${app.studentName}** akan menghapus riwayat ini dan membuka kembali slot waktu. Lanjutkan?`,
                        () => handleFinishAppointment(index),
                        'bg-blue-600 hover:bg-blue-700'
                    );
                });
            });
        }
        
        function handleAdminAction(index, status) {
            if (appointments[index]) {
                // Check for conflicts only if approving
                if (status === 'approved') {
                    const app = appointments[index];
                    const conflictExists = appointments.some((otherApp, otherIndex) => 
                        otherIndex !== index &&
                        otherApp.counselorName === app.counselorName &&
                        otherApp.timeSlot === app.timeSlot &&
                        otherApp.status === 'approved' &&
                        new Date(otherApp.date).toDateString() === new Date(app.date).toDateString()
                    );

                    if (conflictExists) {
                        showAlert('**Gagal disetujui!** Slot waktu tersebut sudah terisi oleh janji temu lain yang disetujui. Mohon tolak permintaan ini.', 'error');
                        return;
                    }
                }
                
                appointments[index].status = status;
                saveAppointments();
                renderAdminAppointments();
                
                // If the Admin is also logged in as a student in another session, their dashboard won't update automatically 
                // but for this demo, we'll only update the admin view.
                
                showAlert(`Janji temu berhasil diubah menjadi: **${status.toUpperCase()}**.`, 'success');
            }
        }
        
        function handleFinishAppointment(index) {
            if (appointments[index] && appointments[index].status === 'approved') {
                const app = appointments[index];
                appointments.splice(index, 1);
                saveAppointments();
                renderAdminAppointments();
                showAlert(`Janji temu dengan **${app.studentName}** telah selesai dan slot waktu kembali tersedia.`, 'success');
            } else {
                showAlert('Gagal menyelesaikan. Janji temu tidak ditemukan atau statusnya bukan disetujui.', 'error');
            }
        }

        function handleDeleteRejectedAppointment(index) {
            if (appointments[index] && appointments[index].status === 'rejected') {
                appointments.splice(index, 1);
                saveAppointments();
                renderAdminAppointments();
                showAlert('Riwayat janji temu yang ditolak telah dihapus.', 'success');
            } else {
                showAlert('Gagal menghapus. Janji temu tidak ditemukan atau statusnya bukan ditolak.', 'error');
            }
        }

        // Admin: Add New Article
        function handleSaveArticle() {
            const title = document.getElementById('article-title-input').value.trim();
            const content = document.getElementById('article-content-input').value.trim();
            
            if (!title || !content) {
                showAlert('Judul dan isi materi wajib diisi.', 'error');
                return;
            }

            const newArticle = {
                title: title,
                content: content,
                author: currentUser, // Admin name
                date: new Date().toISOString()
            };
            
            articles.push(newArticle);
            saveArticles();
            
            document.getElementById('article-title-input').value = '';
            document.getElementById('article-content-input').value = '';
            
            showAlert('Materi motivasi baru berhasil ditambahkan!', 'success');
        }
        
        // --- Admin: Manage Student Accounts (NEW) ---

        function renderUserListForReset() {
            userListForReset.innerHTML = '';
            const studentUsers = users.filter(u => u.role === 'user').sort((a, b) => a.name.localeCompare(b.name));
            
            if (studentUsers.length === 0) {
                userListForReset.innerHTML = '<p class="text-gray-500 italic">Belum ada akun siswa terdaftar.</p>';
                return;
            }

            studentUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex justify-between items-center p-3 border-b last:border-b-0 hover:bg-gray-50';
                userDiv.innerHTML = `
                    <p class="font-medium text-gray-800">${user.name}</p>
                    <div class="flex space-x-2">
                        <button class="reset-password-btn py-1 px-3 bg-amber-500 hover:bg-amber-600 text-white text-sm font-semibold rounded-lg transition-colors" data-username="${user.name}">
                            üîÑ Reset Password
                        </button>
                        <button class="delete-account-btn py-1 px-3 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition-colors" data-username="${user.name}">
                            üóëÔ∏è Hapus Akun
                        </button>
                    </div>
                `;
                userListForReset.appendChild(userDiv);
            });
            
            // Attach reset listeners
            document.querySelectorAll('.reset-password-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userName = e.target.dataset.username;
                    showGenericConfirmation(
                        'Reset Password Siswa',
                        `Apakah Anda yakin ingin mereset password untuk **${userName}** menjadi **'${DEFAULT_STUDENT_PASSWORD}'**?`,
                        () => handleResetStudentPassword(userName),
                        'bg-amber-600 hover:bg-amber-700'
                    );
                });
            });

            // Attach delete listeners
            document.querySelectorAll('.delete-account-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userName = e.target.dataset.username;
                    showGenericConfirmation(
                        'Hapus Akun Siswa',
                        `Anda yakin ingin **menghapus permanen** akun **${userName}**? Semua data janji temu terkait juga akan dihapus. Aksi ini tidak dapat dibatalkan.`,
                        () => handleDeleteStudentAccount(userName),
                        'bg-red-600 hover:bg-red-700'
                    );
                });
            });
        }
        
        function handleAddNewStudent() {
            const studentName = newStudentNameInput.value.trim();
            if (!studentName) {
                showAlert('Nama siswa tidak boleh kosong.', 'error');
                return;
            }
            if (users.some(u => u.name.toLowerCase() === studentName.toLowerCase())) {
                showAlert(`Akun dengan nama **${studentName}** sudah ada.`, 'error');
                return;
            }

            const newStudent = {
                name: studentName,
                role: 'user',
                password: DEFAULT_STUDENT_PASSWORD
            };
            
            users.push(newStudent);
            saveUsers();
            
            newStudentNameInput.value = '';
            renderUserListForReset(); // Update the list
            showAlert(`Akun siswa **${studentName}** berhasil dibuat. Password default: **'${DEFAULT_STUDENT_PASSWORD}'**`, 'success');
        }
        
        function handleResetStudentPassword(userName) {
            const success = updateUserPassword(userName, DEFAULT_STUDENT_PASSWORD);
            if (success) {
                showAlert(`Password akun **${userName}** berhasil direset menjadi **'${DEFAULT_STUDENT_PASSWORD}'**.`, 'success');
            } else {
                showAlert(`Gagal mereset password untuk ${userName}.`, 'error');
            }
        }

        function handleDeleteStudentAccount(userName) {
            const userIndex = users.findIndex(u => u.name === userName && u.role === 'user');
            
            if (userIndex !== -1) {
                // Remove user
                users.splice(userIndex, 1);
                
                // Remove all appointments associated with that user
                appointments = appointments.filter(app => app.studentName !== userName);
                
                saveUsers();
                saveAppointments();
                renderUserListForReset(); // Refresh the list
                
                showAlert(`Akun siswa **${userName}** dan semua data terkait berhasil dihapus.`, 'success');
            } else {
                showAlert(`Gagal menghapus akun. Siswa **${userName}** tidak ditemukan.`, 'error');
            }
        }
        
        // --- Authentication & Initialization ---

        function handleLogin(name, password, role) {
            const user = users.find(u => u.name.toLowerCase() === name.toLowerCase() && u.password === password && u.role === role);
            
            if (user) {
                currentUser = user.name;
                currentRole = user.role;
                
                if (currentRole === 'user') {
                    studentNameHeader.textContent = currentUser;
                    showView('user-dashboard-view');
                    initializeUserDashboard();
                } else {
                    adminNameHeader.textContent = currentUser;
                    showView('admin-dashboard-view');
                    initializeAdminDashboard();
                }
            } else {
                showAlert('Nama pengguna atau password salah.', 'error');
            }
        }
        
        function handleUpdatePassword(oldPassword, newPassword, confirmPassword, isAdmin = false) {
            const user = users.find(u => u.name === currentUser);
            
            if (user.password !== oldPassword) {
                showAlert('Password lama Anda salah.', 'error');
                return;
            }
            if (newPassword.length < 4) {
                showAlert('Password baru minimal harus 4 karakter.', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showAlert('Konfirmasi password tidak cocok dengan password baru.', 'error');
                return;
            }
            
            const success = updateUserPassword(currentUser, newPassword);
            if (success) {
                showAlert('Password berhasil diperbarui.', 'success');
                // Clear inputs
                document.getElementById(isAdmin ? 'admin-old-password-input' : 'old-password-input').value = '';
                document.getElementById(isAdmin ? 'admin-new-password-input' : 'new-password-input').value = '';
                document.getElementById(isAdmin ? 'admin-confirm-password-input' : 'confirm-password-input').value = '';
            } else {
                showAlert('Gagal memperbarui password.', 'error');
            }
        }


        function handleAdminLogin() {
            const name = document.getElementById('admin-name-input').value.trim();
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_BYPASS_TOKEN) {
                 // Bypass login for demonstration purposes
                 const adminUser = users.find(u => u.name.toLowerCase() === name.toLowerCase() && u.role === 'admin');
                 if (adminUser) {
                    handleLogin(adminUser.name, adminUser.password, 'admin');
                    return;
                 }
            }
            handleLogin(name, password, 'admin');
        }

        function handleLogout() {
            currentUser = null;
            currentRole = null;
            showView('login-view');
        }

        function initializeUserDashboard() {
            // Set WhatsApp links
            document.getElementById('chat-gofar-btn').href = `https://wa.me/${gofarNumber}?text=Halo%20Bapak%20Gofar,%20saya%20${currentUser}.%20Saya%20perlu%20konsultasi.`;
            document.getElementById('chat-rohman-btn').href = `https://wa.me/${rohmanNumber}?text=Halo%20Bapak%20Rohman,%20saya%20${currentUser}.%20Saya%20perlu%20konsultasi.`;

            // Reset tab views
            document.querySelectorAll('#user-dashboard-view .tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('content-appointment').classList.remove('hidden');
            document.querySelectorAll('#user-dashboard-view button[id^="tab-"]').forEach(btn => btn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600', 'font-semibold'));
            document.querySelectorAll('#user-dashboard-view button[id^="tab-"]').forEach(btn => btn.classList.add('text-gray-600', 'hover:bg-white', 'hover:shadow-sm', 'font-medium'));
            document.getElementById('tab-appointment').classList.add('bg-white', 'shadow-sm', 'text-blue-600', 'font-semibold');
            document.getElementById('tab-appointment').classList.remove('text-gray-600', 'hover:bg-white', 'hover:shadow-sm', 'font-medium');


            // Render initial content
            resetAppointments();
            renderAppointmentSlots();
            renderMyAppointments();
            renderArticles();
        }
        
        function initializeAdminDashboard() {
            // Reset tab views
            document.querySelectorAll('#admin-dashboard-view .tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('admin-content-appointments').classList.remove('hidden');
            document.querySelectorAll('#admin-dashboard-view button[id^="admin-tab-"]').forEach(btn => btn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600', 'font-semibold'));
            document.querySelectorAll('#admin-dashboard-view button[id^="admin-tab-"]').forEach(btn => btn.classList.add('text-gray-600', 'hover:bg-white', 'hover:shadow-sm', 'font-medium'));
            document.getElementById('admin-tab-appointments').classList.add('bg-white', 'shadow-sm', 'text-blue-600', 'font-semibold');
            document.getElementById('admin-tab-appointments').classList.remove('text-gray-600', 'hover:bg-white', 'hover:shadow-sm', 'font-medium');

            // Render initial content
            renderAdminAppointments();
        }
        
        // --- Event Listeners ---
        
        // 1. Initial Login Selection
        document.getElementById('show-student-login-btn').addEventListener('click', () => showView('student-login-view'));
        document.getElementById('show-admin-login-btn').addEventListener('click', () => showView('admin-login-view'));

        // 2. Back Buttons from Login Forms
        document.getElementById('student-back-btn').addEventListener('click', () => showView('login-view'));
        document.getElementById('admin-back-btn-from-login').addEventListener('click', () => showView('login-view'));

        // 3. Login Buttons
        document.getElementById('student-login-btn').addEventListener('click', () => {
            const name = document.getElementById('student-name-input').value.trim();
            const password = document.getElementById('student-password-input').value;
            handleLogin(name, password, 'user');
        });

        document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);

        // 4. Logout Buttons
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);
        
        // 5. User Tab Navigation
        document.querySelectorAll('#user-dashboard-view button[id^="tab-"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Tutup modal yang mungkin terbuka saat pindah tab
                hideBookingConfirmation();
                hideGenericConfirmation();

                const targetId = e.target.id.replace('tab-', 'content-');
                document.querySelectorAll('#user-dashboard-view .tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');

                // Update tab styles
                document.querySelectorAll('#user-dashboard-view button[id^="tab-"]').forEach(b => {
                    b.classList.remove('bg-white', 'shadow-sm', 'text-blue-600', 'font-semibold');
                    b.classList.add('text-gray-600', 'hover:bg-white', 'hover:shadow-sm', 'font-medium');
                });
                e.target.classList.add('bg-white', 'shadow-sm', 'text-blue-600', 'font-semibold');
                e.target.classList.remove('text-gray-600', 'hover:bg-white', 'hover:shadow-sm', 'font-medium');
                
                // Special rendering logic when switching tabs
                if (targetId === 'content-articles') {
                    renderArticles();
                }
            });
        });
        
        // 6. Admin Tab Navigation
        document.querySelectorAll('#admin-dashboard-view button[id^="admin-tab-"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                hideGenericConfirmation(); // Close any open confirmation modals
                const targetId = e.target.id.replace('admin-tab-', 'admin-content-');
                document.querySelectorAll('#admin-dashboard-view .tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');

                // Update tab styles
                document.querySelectorAll('#admin-dashboard-view button[id^="admin-tab-"]').forEach(b => {
                    b.classList.remove('bg-white', 'shadow-sm', 'text-blue-600', 'font-semibold');
                    b.classList.add('text-gray-600', 'hover:bg-white', 'hover:shadow-sm', 'font-medium');
                });
                e.target.classList.add('bg-white', 'shadow-sm', 'text-blue-600', 'font-semibold');
                e.target.classList.remove('text-gray-600', 'hover:bg-white', 'hover:shadow-sm', 'font-medium');
                
                // Special rendering logic when switching tabs
                if (targetId === 'admin-content-appointments') {
                    renderAdminAppointments();
                } else if (targetId === 'admin-content-manage-accounts') {
                    renderUserListForReset();
                }
            });
        });

        // 7. Booking Modal Actions
        bookingModalCancelBtn.addEventListener('click', hideBookingConfirmation);
        bookingModalConfirmBtn.addEventListener('click', confirmAppointment);
        
        // 8. Custom Alert Modal Action
        alertOkBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

        // 9. Admin: Save Article
        document.getElementById('save-article-btn').addEventListener('click', handleSaveArticle);
        
        // 10. Admin: Add New Student
        addNewStudentBtn.addEventListener('click', handleAddNewStudent);
        
        // 11. User: Change Password
        document.getElementById('update-password-btn').addEventListener('click', () => {
             const oldPass = document.getElementById('old-password-input').value;
             const newPass = document.getElementById('new-password-input').value;
             const confirmPass = document.getElementById('confirm-password-input').value;
             handleUpdatePassword(oldPass, newPass, confirmPass, false);
        });
        
        // 12. Admin: Change Password
        document.getElementById('admin-update-password-btn').addEventListener('click', () => {
             const oldPass = document.getElementById('admin-old-password-input').value;
             const newPass = document.getElementById('admin-new-password-input').value;
             const confirmPass = document.getElementById('admin-confirm-password-input').value;
             handleUpdatePassword(oldPass, newPass, confirmPass, true);
        });
        
        // Initial setup
        showView('login-view');

    </script>
</body>
</html>